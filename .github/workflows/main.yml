name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GCP_PROJECT: smiling-spring-462009-t0   # Replace with your secret name for the GCP project ID
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Authenticate to GCP using the JSON key stored in GitHub Secrets.
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}   # Replace with your secret name for the service‚Äêaccount JSON key

      # Install gcloud CLI and set the project
      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ env.GCP_PROJECT }}

      # Configure Docker to use gcloud credential helper for GCR
      - name: Configure Docker for GCR
        run: |
          gcloud auth configure-docker

      # Build and push Docker image: cyna-config-server
      - name: Build and push Docker image cyna-config-server
        run: |
          docker build \
            -t gcr.io/${{ env.GCP_PROJECT }}/cyna-config-server:latest \
            ./config-server
          docker push gcr.io/${{ env.GCP_PROJECT }}/cyna-config-server:latest

      # Build and push Docker image: cyna-eureka-server
      - name: Build and push Docker image cyna-eureka-server
        run: |
          docker build \
            -t gcr.io/${{ env.GCP_PROJECT }}/cyna-eureka-server:latest \
            ./EurekaServer
          docker push gcr.io/${{ env.GCP_PROJECT }}/cyna-eureka-server:latest

      # Build and push Docker image: cyna-api-gateway
      - name: Build and push Docker image cyna-api-gateway
        run: |
          docker build \
            -t gcr.io/${{ env.GCP_PROJECT }}/cyna-api-gateway:latest \
            ./api-gateway
          docker push gcr.io/${{ env.GCP_PROJECT }}/cyna-api-gateway:latest

      # Build and push Docker image: cyna-auth-users
      - name: Build and push Docker image cyna-auth-users
        run: |
          docker build \
            -t gcr.io/${{ env.GCP_PROJECT }}/cyna-auth-users:latest \
            ./auth-users
          docker push gcr.io/${{ env.GCP_PROJECT }}/cyna-auth-users:latest

      # Build and push Docker image: cyna-products
      - name: Build and push Docker image cyna-products
        run: |
          docker build \
            -t gcr.io/${{ env.GCP_PROJECT }}/cyna-products:latest \
            ./products
          docker push gcr.io/${{ env.GCP_PROJECT }}/cyna-products:latest

      # Build and push Docker image: cyna-subscriptions
      - name: Build and push Docker image cyna-subscriptions
        run: |
          docker build \
            -t gcr.io/${{ env.GCP_PROJECT }}/cyna-subscriptions:latest \
            ./subscriptions
          docker push gcr.io/${{ env.GCP_PROJECT }}/cyna-subscriptions:latest
